(function(c){function l(a,b,c){this.obj=a;this.start=b;this.end=c}var i=function(a,b,h){this.obj=a;this.info=b;this.parent=h;this.children=[];this.editing=this.moving=!1;this.moveTimer=0;this.obj.movementStopped=!1;this.hasLayout=this.visible=!0;this.y=this.x=1;this.dy=this.dx=0;this.hasPosition=!1;this.el=c("<div>"+this.info+"</div>");this.el.css("position","absolute");this.el.addClass("node");c(".buzzmap-active").prepend(this.el);this.parent?(this.obj.lines[this.obj.lines.length]=new l(a,this,h),
this.parent.children.push(this)):this.el.addClass("active");var f=this,e=function(){return f.children.length>0?(f.el.toggleClass("active"),f.obj.root.animateToStatic(),!1):!0};this.el.draggable({drag:function(){if(typeof f.obj.options.ondrag==="function")f.obj.options.ondrag(f.obj.root);f.obj.root.animateToStatic()}});this.obj.options.editable===!0&&this.el.dblclick(function(){f.editing=!0;f.edit()});this.el.click(function(){f.obj.options.editable===!0?setTimeout(function(){if(f.editing===!0)return!1;
e()},500):e();return!0})};i.prototype.serialize=function(){var a='{"node":"'+c(this.el).html().replace(/"/g,'\\"')+'","children":[',b=0;c.each(this.children,function(){this.el.hasClass("addNode")||(b++,b>1&&(a+=","),a+=this.serialize())});return a+"]}"};i.prototype.edit=function(){var a=this;if(this.el.hasClass("addNode"))return!0;var b=c(":eq(0)",this.el).html();this.el.html("");var h=function(){a.el.html(c("<span>"+b+"</span>"));a.editing=!1;a.obj.root.animateToStatic()},f=c('<input type="text"/>').val(b);
f.blur(function(){if(c.trim(b)==="")return!0;h()});f.click(function(){return!1});f.keyup(function(b){b=b.which;if(b===27)h();else if(b===13){b=f.val();a.el.html(c("<span>"+b+"</span>"));if(typeof a.obj.options.onchange==="function")a.obj.options.onchange(a,a.obj.root.serialize());a.editing=!1;a.obj.root.animateToStatic()}return!0});f.appendTo(a.el).focus().select();c('<a style="margin-left:0.5em;" href="#">[+]</a>').click(function(){a.obj.original.addNode(a,"...").edit();a.obj.root.animateToStatic();
h();return!1}).appendTo(a.el);a!==this.obj.root&&c('<a style="margin-left:0.5em;" href="#">[x]</a>').click(function(){h();a.removeNode();a.obj.root.animateToStatic();return!1}).appendTo(a.el);return!1};i.prototype.animateToStatic=function(){var a=this;clearTimeout(this.moveTimer);this.moveTimer=setTimeout(function(){a.obj.movementStopped=!0},this.obj.options.timeout*1E3);if(!this.moving)this.moving=!0,this.obj.movementStopped=!1,this.animateLoop()};i.prototype.animateLoop=function(){var a=this;this.obj.canvas.clear();
for(var b=0;b<this.obj.lines.length;b++)this.obj.lines[b].updatePosition();this.findEquilibrium()||this.obj.movementStopped?this.moving=!1:setTimeout(function(){a.animateLoop()},1E3/this.obj.options.frameRate)};i.prototype.findEquilibrium=function(){var a;a=this.display()&&!0;for(var b=0;b<this.children.length;b++)if(this.children[b].visible||this.el.hasClass("active"))a=this.children[b].findEquilibrium()&&a;return a};i.prototype.display=function(){if(this.visible){if(this.parent!==null&&!this.parent.el.hasClass("active")){if(typeof this.obj.options.onhide===
"function")this.obj.options.onhide(this);this.el.hide();this.visible=!1}this.el.hasClass("active")||c.each(this.children,function(a,b){b.el.removeClass("active")})}else if(this.el.hasClass("active")||this.parent.el.hasClass("active"))if(this.el.show(),this.visible=!0,typeof this.obj.options.onshow==="function")this.obj.options.onshow(this);this.drawn=!0;if(!this.hasPosition)this.x=this.obj.options.mapArea.x/2,this.y=this.obj.options.mapArea.y/2,this.el.css("left",this.x+"px"),this.el.css("top",this.y+
"px"),this.hasPosition=!0;var a=Math.PI*2/this.children.length,b=this;c.each(this.children,function(c){if(!this.hasPosition&&this.el.css("display")!=="none")c*=a,this.x=50*Math.cos(c)+b.x,this.y=50*Math.sin(c)+b.y,this.hasPosition=!0,this.el.css("left",this.x+"px"),this.el.css("top",this.y+"px")});return this.updatePosition()};i.prototype.updatePosition=function(){if(c(this.el).hasClass("ui-draggable-dragging"))return this.x=parseInt(this.el.css("left"))+c(this.el).width()/2,this.y=parseInt(this.el.css("top"))+
c(this.el).height()/2,this.dy=this.dx=0,!1;var a=this.getForceVector();this.dx+=a.x*this.obj.options.acceleration;this.dy+=a.y*this.obj.options.acceleration;this.dx*=this.obj.options.damping;this.dy*=this.obj.options.damping;if(Math.abs(this.dx)<this.obj.options.minSpeed)this.dx=0;if(Math.abs(this.dy)<this.obj.options.minSpeed)this.dy=0;if(Math.abs(this.dx)+Math.abs(this.dy)==0)return!0;this.x+=this.dx*this.obj.options.acceleration;this.y+=this.dy*this.obj.options.acceleration;this.x=Math.min(this.obj.options.mapArea.x,
Math.max(1,this.x));this.y=Math.min(this.obj.options.mapArea.y,Math.max(1,this.y));var a=this.x-c(this.el).width()/2,b=this.y-c(this.el).height()/2-10;this.el.css("left",a+"px");this.el.css("top",b+"px");return!1};i.prototype.getForceVector=function(){for(var a=0,b=0,h=this.obj.nodes,f=this.obj.lines,e=0;e<h.length;e++)if(h[e]!==this&&(!this.obj.options.showSublines||h[e].hasLayout)&&h[e].visible){var d=h[e].x-this.x,g=h[e].y-this.y,j=d/Math.abs(d);Math.abs(g);var k=Math.sqrt(d*d+g*g),g=Math.atan(g/
d);d===0&&(g=Math.PI/2,j=0);d=this.obj.options.repulse*500/(k*k);Math.abs(k)<500&&(a+=-d*Math.cos(g)*j,b+=-d*Math.sin(g)*j)}e=this.x+c(this.el).width();d=this.obj.options.wallrepulse*500/(e*e);a+=Math.min(2,d);e=this.obj.options.mapArea.x-e;d=-(this.obj.options.wallrepulse*500)/(e*e);a+=Math.max(-2,d);d=this.obj.options.wallrepulse*500/(this.y*this.y);b+=Math.min(2,d);e=this.obj.options.mapArea.y-this.y;d=-(this.obj.options.wallrepulse*500)/(e*e);b+=Math.max(-2,d);for(e=0;e<f.length;e++){h=null;if(f[e].start===
this)h=f[e].end;else if(f[e].end===this)h=f[e].start;else continue;h.visible&&(d=h.x-this.x,g=h.y-this.y,k=Math.sqrt(d*d+g*g),j=d/Math.abs(d),g=Math.atan(g/d),d==0&&(g=Math.PI/2,j=0),d=this.obj.options.attract*k/1E4,Math.abs(k)>0&&(a+=d*Math.cos(g)*j,b+=d*Math.sin(g)*j))}if(!this.parent)h=this.obj.options.mapArea,d=h.x/2-this.obj.options.centerOffset-this.x,g=h.y/2-this.y,k=Math.sqrt(d*d+g*g),j=d/Math.abs(d),g=Math.atan(g/d),d===0&&(g=Math.PI/2,j=0),d=0.1*this.obj.options.attract*k*this.obj.options.centerAttraction/
1E3,Math.abs(k)>0&&(a+=d*Math.cos(g)*j,b+=d*Math.sin(g)*j);Math.abs(a)>this.obj.options.maxForce&&(a=this.obj.options.maxForce*(a/Math.abs(a)));Math.abs(b)>this.obj.options.maxForce&&(b=this.obj.options.maxForce*(b/Math.abs(b)));return{x:a,y:b}};i.prototype.removeNode=function(){if(typeof this.obj.options.onremove==="function")this.obj.options.onremove(this);for(var a=0;a<this.children.length;a++)this.children[a].removeNode();var b=this.obj.nodes;this.obj.nodes=[];for(a=0;a<b.length;a++)b[a]!==this&&
this.obj.nodes.push(b[a]);b=this.obj.lines;this.obj.lines=[];for(a=0;a<b.length;a++)b[a].start===this||b[a].end===this||this.obj.lines.push(b[a]);c(this.el).remove();if(typeof this.obj.options.onchange==="function")this.obj.options.onchange(this,this.obj.root.serialize())};l.prototype.updatePosition=function(){if(this.obj.options.showSublines||this.start.visible&&this.end.visible)if(!this.obj.options.showSublines||this.start.hasLayout&&this.end.hasLayout)this.strokeStyle=this.obj.options.lineColor,
this.strokeWidth=this.obj.options.lineWidth,this.strokeOpacity=this.obj.options.lineOpacity,this.obj.canvas.path("M"+this.start.x+" "+this.start.y+"L"+this.end.x+" "+this.end.y).attr({stroke:this.strokeStyle,opacity:this.strokeOpacity,"stroke-width":this.strokeWidth})};c.fn.addNode=function(a,b){var c=this[0],f=c.nodes[c.nodes.length]=new i(c,b,a);c.root.animateToStatic();return f};c.fn.addRootNode=function(a){a=this[0].nodes[0]=new i(this[0],a,null);this[0].root=a;this[0].original=this;return a};
c.fn.buzzmap=function(a){var b=c("ul:eq(0)",this);if(!b.hasClass("buzzmap-active"))return a=c.extend({mapArea:{x:-1,y:-1},loadData:null,editable:!1,onchange:function(){},ondrag:function(){},onshow:function(){},onhide:function(){},onremove:function(){},attract:12,repulse:10,maxForce:0.15,damping:0.9,acceleration:3.5,lineWidth:"5px",lineColor:"#FFF",lineOpacity:0.3,wallrepulse:0.5,centerOffset:100,centerAttraction:0,minSpeed:0.05,frameRate:50,timeout:5},a),b.each(function(){var h=this;this.mindmapInit=
!0;this.nodes=[];this.lines=[];this.activeNode=null;this.options=a;this.animateToStatic=function(){this.root.animateToStatic()};c(window).resize(function(){h.animateToStatic()});if(a.mapArea.x==-1)a.mapArea.x=c(window).width();if(a.mapArea.y==-1)a.mapArea.y=c(window).height();this.canvas=Raphael(0,0,a.mapArea.x,a.mapArea.y);c(this).addClass("buzzmap-active");if(a.loadData){var f=c.parseJSON(a.loadData),e=function(a,d){c.each(d,function(c,d){node=b.addNode(a,decodeURI(d.node));e(node,d.children)})},
d=b.addRootNode(decodeURI(f.node),{});c.each(f.children,function(a,c){node=b.addNode(d,decodeURI(c.node));e(node,c.children)})}else{$el=c(">li",this);d=$el.get(0).mynode=b.addRootNode(c(">li>div",this).html());$el.hide();var g=function(){var a=c(this).parents("li").get(0),a=typeof a==="undefined"?d:a.mynode;this.mynode=b.addNode(a,c("div:eq(0)",this).html(),{});c(this).hide();c(">ul>li",this).each(g)};c(">li>ul",b).each(function(){c(">li",this).each(g)})}})}})(jQuery);
